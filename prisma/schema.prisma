generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  EMPLOYEE
  HR_ADMIN
  COMPANY_ADMIN
  SUPER_ADMIN
}

enum TimeEntryType {
  ENTRY
  EXIT
}

enum WorkMode {
  PRESENTIAL
  REMOTE
}

enum AbsenceType {
  SICK
  LICENSE
  UNJUSTIFIED
  OTHER
}

enum AbsenceStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DocumentStatus {
  PENDING
  VIEWED
  SIGNED
}

model Tenant {
  id          String   @id @default(uuid())
  name        String
  taxId       String?
  planType    String   @default("BASIC")
  address     String?
  city        String?
  state       String?
  country     String?
  logoUrl     String?
  
  // Geolocation Configuration
  officeAddress String?  // Display address
  officeLat     Float?
  officeLng     Float?
  officeRadius  Int      @default(300) // Meters

  config      Json?    // Stores branding, work rules, ip restrictions
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  timeEntries TimeEntry[]
  absences    AbsenceReport[]
  payslips    Payslip[]
  reviews     PerformanceReview[]

  @@map("tenants")
}

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  password    String?  // Nullable if using Auth provider purely
  fullName    String?
  role        UserRole @default(EMPLOYEE)
  tenantId    String
  
  // Profile Fields
  logoUrl     String? // Re-using logic if needed, or avatarUrl
  avatarUrl   String?
  jobTitle    String?
  phone       String?
  address     String?
  city        String?
  state       String?
  country     String?
  
  // Geolocation for Home Office
  homeLat     Float?
  homeLng     Float?
  
  profile     Json?    // Deprecated in favor of explicit fields, kept for backward comp if any
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant              Tenant              @relation(fields: [tenantId], references: [id])
  accounts            Account[] // Relation to OAuth accounts
  timeEntries         TimeEntry[]
  absences            AbsenceReport[]
  payslips            Payslip[]
  reviewsMy           PerformanceReview[] @relation("EmployeeReviews")
  reviewsGiven        PerformanceReview[] @relation("ReviewerReviews")

  @@map("users")
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model TimeEntry {
  id          String        @id @default(uuid())
  userId      String
  tenantId    String
  type        TimeEntryType
  mode        WorkMode
  timestamp   DateTime
  location    Json?         // lat, lng
  ipAddress   String?
  deviceId    String?
  metadata    Json?         // selfieUrl, accuracy
  isVerified  Boolean       @default(false)
  createdAt   DateTime      @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@map("time_entries")
}

model AbsenceReport {
  id          String        @id @default(uuid())
  userId      String
  tenantId    String
  type        AbsenceType
  status      AbsenceStatus @default(PENDING)
  startDate   DateTime
  endDate     DateTime
  description String?
  attachments Json?
  comments    Json?         // Simple thread structure
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@map("absence_reports")
}

model Payslip {
  id          String         @id @default(uuid())
  userId      String
  tenantId    String
  period      DateTime       // First day of the month
  fileUrl     String
  status      DocumentStatus @default(PENDING)
  signedAt    DateTime?
  signMeta    Json?          // IP, Device of signer
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@map("payslips")
}

model PerformanceReview {
  id          String   @id @default(uuid())
  userId      String
  reviewerId  String
  tenantId    String
  period      String   // "Q1-2024", etc.
  score       Float?
  content     Json?    // Objectives, feedback
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user     User   @relation("EmployeeReviews", fields: [userId], references: [id], onDelete: Cascade)
  reviewer User   @relation("ReviewerReviews", fields: [reviewerId], references: [id])
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  @@map("performance_reviews")
}
